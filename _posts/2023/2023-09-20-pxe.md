---
title: PXE(Pre-boot eXecution Environment) 개념, 사용법 
date: 2023-09-20 20:11:22 +0900
author: kkamji
categories: [System, Linux]
tags: [pxe, os, linux, centos, dhcp, tftp, ftp]     # TAG names should always be lowercase
comments: true
image:
  path: /assets/img/kkam-img/kkam.webp
---

만약 퇴근 1시간 전, 사무실 컴퓨터 40대에 OS를 설치해야 하는데 USB가 1개뿐이라면?

멘붕이 올 수 있다. 이때 사용할 수 있는 기술이 바로 PXE(Pre-boot eXecution Environment)입니다.  

실습 환경 => CentOS, VMware

---

## 1. PXE의 개념

기본적으로 서버나 PC를 켜면, 부팅 우선순위에 따라 디바이스나 디스크를 선택하고, 해당 디바이스나 디스크에서 운영체제를 탐색합니다. 만약 부팅 우선순위에 있는 디바이스나 디스크에서 운영체제를 찾지 못했을 때, 마지막으로 서버나 PC는 운영체제를 설치할 수 있는 네트워크 서버를 탐색하게 됩니다. 이때 네트워크상에서 운영체제를 설치하는 서버가 바로 PXE Server입니다. Client는 PXE Server를 통해 IP와 OS를 받을 수 있습니다.

---

## 2. PXE Server의 구성 요소

### 2.1. DHCP Server

- IP가 없는 베어메탈 Client와 통신을 위해 사용됩니다

### 2.2. TFTP Server

- OS 설치에 필요한 절차가 담긴 설정 파일 전송을 위해 사용
- UDP 기반 통신(부트 로딩)에 사용

### 2.3. FTP Server

- 실제 ISO 파일을 전송할 때 사용
- TCP/IP 기반 통신(신뢰성, 보안성)

---

## 3. PXE Server 구축하기

### 3.1. 방화벽, SELinux, NetworkManager 끄기

CentOS는 Network 설정에 NetworkManager와 `/etc/sysconfig/network-scripts/ifcfg-ens32`가 사용됩니다. 두 개의 설정이 충돌할 수 있으므로 FTP, TFTP 통신을 위해 방화벽과 SELinux, NetworkManager를 중지합니다.

=> **ifcfg-ens32는 상황에 따라 ens33이 될 수도 있고 eth0이 될 수도 있습니다.**  

```shell
# NetworkManager 중단 및 재부팅 후 자동 실행 막기
systemctl disable --now NetworkManager

# 방화벽(firewalld) 중단 및 재부팅 후 자동 실행 막기
systemctl disable --now firewalld

# SELinux 중단 및 재부팅 후 자동 실행 막기
sed -i s/SELINUX=enforcing/SELINUX=disabled/g /etc/selinux/config

# 만약 위 명령어가 작동하지 않을 시 vi나 nano를 통해 /etc/selinux/config 파일에 접근 후 SELINUX=enforcing에 해당하는 부분을 SELINUX=disabled로 바꿔주세요
```

### 3.2. DHCP 서버, TFTP package 다운로드 및 설정

```shell
# DHCP, FTP, TFTP package 다운로드
yum -y install dhcp tftp-server vsftpd

# DHCP 설정
vi /etc/dhcp/dhcpd.conf
	
-------------------------예시----------------------------
subnet 211.183.3.0 netmask 255.255.255.0
{
  # GW
  option routers 211.183.3.2;

  # SM
  option subnet-mask 255.255.255.0;

  # IP를 받아올 수 없는 상황에서도 IP를 부여받을 수 있도록
  range dynamic-bootp 211.183.3.240 211.183.3.250;

  # DNS
  option domain-name-servers 8.8.8.8;

  # 부팅 허용
  allow booting;

  # PXE 서버의 주소
  next-server 211.183.3.21;

  # Filename 설정
  "pxelinux.0";
}
-------------------------------------------------------

# DHCP 재시작
systemctl restart dhcpd

```

<p align="left">
	<img src="https://github.com/kkamji98/kkamji98.github.io/assets/72260110/bfd3195d-71c0-444e-a070-05deba6bda59" alt=""/>
</p>

### 3.3. TFTP로 운영체제 설치 파일(ISO), 부트로더 전송을 위한 설정

TFTP로 전송할 파일은 다음과 같습니다.

1. vmlinuz: 압축된 커널
2. initrd.img: 임시 저장공간으로 사용할 램디스크
3. pxelinux.0: PXE에 존재하는 부팅에 필요한 파일

- boot-loader: 부팅을 위한 로더와 사전 절차 정의 파일
- /var/lib/tftpboot: 사용자가 TFTP로 서버에 접속할 때 사용하는 기본 경로

```shell
# mount /{ISO 파일이 들어있는 경로} /media
mount /dev/cdrom /media

# 압축된 커널 복사 (vmlinuz)
cp /media/images/pxeboot/vmlinuz /var/lib/tftpboot

# 임시 저장공간으로 사용할 램디스크 복사 (OS 설치 이전에는 디스크가 존재하지 않기 때문)
cp /media/images/pxeboot/initrd.img /var/lib/tftpboot

# PXE에 존재하는 부팅에 필요한 파일 복사
yum -y install syslinux
cp /usr/share/syslinux/pxelinux.0 /var/lib/tftpboot/

# TFTP 서비스의 실행 여부 설정 (disable -> no)
vi /etc/xinetd.d/tftp

# TFTP 재시작
systemctl status tftp
systemctl enable --now tftp

```

### 3.4. FTP로 운영체제 파일 전송을 위한 준비

```shell
cp -r /media/* /var/ftp/pub

mkdir /var/lib/tftpboot/pxelinux.cfg
cd /var/lib/tftpboot/pxelinux.cfg

# PXE 설치를 위한 절차를 /var/lib/tftpboot/pxelinux.cfg/default에 정의

--------------------------default 파일 내용---------------------------
DEFAULT CentOS7_Auto_Install 
LABEL CentOS7_Auto_Install 
	kernel vmlinuz # 커널 정보는 여기 담겨있다 
	APPEND initrd=initrd.img repo=ftp://211.183.3.21/pub 

----------------------------------------------------------------------

# FTP Daemon 재시작
systemctl enable --now vsftpd
```

---

## 4. PXE를 사용해 Client에 OS 설치하기

### 4.1. 클라이언트에 CD/DVD가 들어있지 않음

PXE를 사용하기 위해서는 PXE Server에서 DHCP 주소를 받아야 하므로 Network Adapter를 NAT로 설정했습니다. NAT 네트워크 대역은 211.183.3.0/24입니다.
![image](https://github.com/kkamji98/kkamji98.github.io/assets/72260110/9c8214d8-84ea-4e18-bcd3-3e2270cfe35c)

### 4.2. DHCP Server를 통해 주소 부여받기

![image](https://github.com/kkamji98/kkamji98.github.io/assets/72260110/28066284-64db-4667-bbad-d3ef05316e01)

### 4.3. PXE를 통한 OS 설치 가능 여부 확인

![image](https://github.com/kkamji98/kkamji98.github.io/assets/72260110/7dfd87af-7abd-43dc-9ecd-b8d8745f72bd)

<br><br>

> **궁금하신 점이나 추가해야 할 부분은 댓글이나 아래의 링크를 통해 문의해주세요.**  
> **Written with [KKamJi](https://www.linkedin.com/in/taejikim/)**
{: .prompt-info}
