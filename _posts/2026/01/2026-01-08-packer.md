---
title: Packer로 Golden Image 만들기
date: 2026-01-08 00:00:00 +0900
author: kkamji
categories: [IaC, Packer]
tags: [packer, hashicorp, golden-image, ami, aws, infrastructure-as-code]
comments: true
image:
  path: /assets/img/packer/packer.webp
---

## 1. Packer란?

Packer는 HashiCorp에서 개발한 오픈 소스 도구로, 단일 소스 구성에서 여러 플랫폼에 대한 동일한 머신 이미지를 자동으로 생성할 수 있습니다. AWS AMI, Azure Image, GCP Image, Docker Image, VMware 등 다양한 플랫폼을 지원하며, 인프라를 코드로 관리(Infrastructure as Code)하는 데 핵심적인 역할을 합니다.

### 1.1. Golden Image란?

Golden Image(또는 Base Image)는 운영 환경에서 사용할 서버의 기본 템플릿입니다. 필요한 패키지, 보안 설정, 모니터링 에이전트 등이 미리 설치되어 있어 새로운 서버를 빠르고 일관되게 배포할 수 있습니다.

### 1.2. Packer를 사용하는 이유

- **일관성**: 동일한 설정의 이미지를 반복적으로 생성
- **자동화**: 수동 작업 없이 CI/CD 파이프라인에 통합 가능
- **멀티 플랫폼**: 하나의 템플릿으로 여러 클라우드 플랫폼용 이미지 생성
- **버전 관리**: 이미지 구성을 코드로 관리하여 변경 이력 추적

---

## 2. Packer의 주요 개념

### 2.1. Template

- Packer의 구성 파일로, JSON 또는 HCL2 형식으로 작성합니다.
- 이미지를 어떻게 빌드할지 정의합니다.

### 2.2. Builder

- 특정 플랫폼용 이미지를 생성하는 컴포넌트입니다.
- 예: `amazon-ebs`, `azure-arm`, `googlecompute`, `docker` 등

### 2.3. Provisioner

- 이미지에 소프트웨어를 설치하고 구성하는 컴포넌트입니다.
- 예: `shell`, `ansible`, `chef`, `puppet` 등

### 2.4. Post-processor

- 빌드가 완료된 후 추가 작업을 수행합니다.
- 예: 이미지 압축, 업로드, 태깅 등

---

## 3. Packer 동작 방식

Packer는 이미지를 빌드할 때 다음과 같은 순서로 동작합니다.

**Packer Build Process**

1. **Template 로드**
   - HCL/JSON 파일 파싱 및 변수 처리

2. **Builder 실행**
   - 임시 인스턴스/컨테이너 생성
   - SSH/WinRM 연결 대기

3. **Provisioner 실행**
   - Shell 스크립트, Ansible 등으로 소프트웨어 설치
   - 설정 파일 복사 및 시스템 구성

4. **Post-processor 실행** (선택)
   - 이미지 압축, 태깅, 다른 리전 복사 등

5. **이미지 생성 및 정리**
   - 임시 인스턴스에서 이미지(AMI/Image) 생성
   - 임시 리소스 정리 (인스턴스, 키페어, 보안그룹 등)

### 3.1. 상세 동작 흐름

1. **Template 로드**: Packer는 HCL2 또는 JSON 형식의 템플릿 파일을 읽고, 변수를 처리하며 구성을 검증합니다.

2. **Builder 실행**: 지정된 플랫폼(AWS, GCP 등)에 임시 인스턴스를 생성합니다. 이 과정에서 임시 SSH 키페어와 보안 그룹도 자동으로 생성됩니다.

3. **Provisioner 실행**: SSH 또는 WinRM으로 인스턴스에 연결한 후, 정의된 Provisioner들을 순차적으로 실행합니다. 이 단계에서 패키지 설치, 설정 파일 배포, 서비스 구성 등이 이루어집니다.

4. **Post-processor 실행**: 빌드가 완료된 후 추가 작업을 수행합니다. 예를 들어 AMI를 다른 리전에 복사하거나, Docker 이미지를 레지스트리에 푸시하는 작업 등이 있습니다.

5. **이미지 생성 및 정리**: 인스턴스를 중지하고 스냅샷을 생성하여 최종 이미지를 만듭니다. 이후 임시로 생성했던 모든 리소스(인스턴스, 키페어, 보안 그룹 등)를 자동으로 정리합니다.

> Packer는 빌드 실패 시에도 임시 리소스를 정리하려고 시도합니다. 하지만 네트워크 문제 등으로 정리가 실패할 수 있으므로, 빌드 실패 후에는 임시 리소스가 남아있지 않은지 확인하는 것이 좋습니다.  
{: .prompt-warning}

---

## 4. Packer 설치

### 4.1. macOS (Homebrew)

```bash
❯ brew tap hashicorp/tap
❯ brew install hashicorp/tap/packer

❯ packer version
Packer v1.11.2
```

### 4.2. Linux (Ubuntu/Debian)

```bash
❯ wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
❯ echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
❯ sudo apt update && sudo apt install packer

❯ packer version
Packer v1.11.2
```

### 4.3. Windows (Chocolatey)

```powershell
❯ choco install packer

❯ packer version
Packer v1.11.2
```

---

## 5. Packer 사용 예시 (AWS AMI 생성)

> AWS AMI를 생성하는 간단한 예시입니다. Ubuntu 기반 이미지에 Nginx를 설치하는 Golden Image를 만들어보겠습니다.  
{: .prompt-info}

### 5.1. 디렉토리 구조

```
packer-example/
├── aws-ubuntu.pkr.hcl
└── scripts/
    └── setup.sh
```

### 5.2. Packer Template 작성 (aws-ubuntu.pkr.hcl)

```hcl
packer {
  required_plugins {
    amazon = {
      source  = "github.com/hashicorp/amazon"
      version = "~> 1"
    }
  }
}

variable "aws_region" {
  type    = string
  default = "ap-northeast-2"
}

variable "instance_type" {
  type    = string
  default = "t3.micro"
}

variable "ami_name" {
  type    = string
  default = "golden-image-ubuntu"
}

source "amazon-ebs" "ubuntu" {
  ami_name      = "${var.ami_name}-{{timestamp}}"
  instance_type = var.instance_type
  region        = var.aws_region

  source_ami_filter {
    filters = {
      name                = "ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*"
      root-device-type    = "ebs"
      virtualization-type = "hvm"
    }
    most_recent = true
    owners      = ["099720109477"] # Canonical
  }

  ssh_username = "ubuntu"

  tags = {
    Name        = var.ami_name
    Environment = "production"
    Builder     = "packer"
  }
}

build {
  sources = ["source.amazon-ebs.ubuntu"]

  provisioner "shell" {
    script = "scripts/setup.sh"
  }
}
```

### 5.3. Provisioner 스크립트 작성 (scripts/setup.sh)

```bash
#!/bin/bash
set -e

echo "=== Updating system packages ==="
sudo apt-get update
sudo apt-get upgrade -y

echo "=== Installing Nginx ==="
sudo apt-get install -y nginx

echo "=== Installing monitoring tools ==="
sudo apt-get install -y htop curl wget vim

echo "=== Enabling Nginx service ==="
sudo systemctl enable nginx

echo "=== Cleaning up ==="
sudo apt-get clean
sudo rm -rf /var/lib/apt/lists/*

echo "=== Setup completed ==="
```

### 5.4. Packer 실행

#### 5.4.1. 플러그인 초기화

```bash
❯ packer init aws-ubuntu.pkr.hcl

Installed plugin github.com/hashicorp/amazon v1.3.3 in "/Users/kkamji/.config/packer/plugins/..."
```

#### 5.4.2. 템플릿 유효성 검사

```bash
❯ packer validate aws-ubuntu.pkr.hcl

The configuration is valid.
```

#### 5.4.3. 이미지 빌드

```bash
❯ packer build aws-ubuntu.pkr.hcl

amazon-ebs.ubuntu: output will be in this color.

==> amazon-ebs.ubuntu: Prevalidating any provided VPC information
==> amazon-ebs.ubuntu: Prevalidating AMI Name: golden-image-ubuntu-1704700000
    amazon-ebs.ubuntu: Found Image ID: ami-0c55b159cbfafe1f0
==> amazon-ebs.ubuntu: Creating temporary keypair...
==> amazon-ebs.ubuntu: Launching a source AWS instance...
    amazon-ebs.ubuntu: Instance ID: i-0123456789abcdef0
==> amazon-ebs.ubuntu: Waiting for instance to become ready...
==> amazon-ebs.ubuntu: Using SSH communicator to connect: 54.180.xxx.xxx
==> amazon-ebs.ubuntu: Waiting for SSH to become available...
==> amazon-ebs.ubuntu: Connected to SSH!
==> amazon-ebs.ubuntu: Provisioning with shell script: scripts/setup.sh
    amazon-ebs.ubuntu: === Updating system packages ===
    amazon-ebs.ubuntu: === Installing Nginx ===
    amazon-ebs.ubuntu: === Installing monitoring tools ===
    amazon-ebs.ubuntu: === Enabling Nginx service ===
    amazon-ebs.ubuntu: === Cleaning up ===
    amazon-ebs.ubuntu: === Setup completed ===
==> amazon-ebs.ubuntu: Stopping the source instance...
==> amazon-ebs.ubuntu: Waiting for the instance to stop...
==> amazon-ebs.ubuntu: Creating AMI golden-image-ubuntu-1704700000 from instance i-0123456789abcdef0
    amazon-ebs.ubuntu: AMI: ami-0987654321fedcba0
==> amazon-ebs.ubuntu: Waiting for AMI to become ready...
==> amazon-ebs.ubuntu: Terminating the source AWS instance...
==> amazon-ebs.ubuntu: Cleaning up any extra volumes...
==> amazon-ebs.ubuntu: No volumes to clean up, skipping
Build 'amazon-ebs.ubuntu' finished after 5 minutes 23 seconds.

==> Wait completed after 5 minutes 23 seconds

==> Builds finished. The artifacts of successful builds are:
--> amazon-ebs.ubuntu: AMIs were created:
ap-northeast-2: ami-0987654321fedcba0
```

---

## 6. 주요 명령어 정리

| 명령어 | 설명 |
|--------|------|
| `packer init` | 필요한 플러그인 초기화 |
| `packer validate` | 템플릿 문법 검증 |
| `packer fmt` | 템플릿 포맷팅 |
| `packer build` | 이미지 빌드 실행 |
| `packer build -var "key=value"` | 변수 전달하며 빌드 |
| `packer build -var-file="vars.pkrvars.hcl"` | 변수 파일 사용 |

---

## 7. 요약

이 포스트에서는 Packer의 개념과 주요 구성 요소를 살펴보고, 설치 방법과 AWS AMI를 생성하는 기본적인 사용 방법을 소개했습니다. Packer를 활용하면 Golden Image를 코드로 관리할 수 있어 일관된 인프라 환경을 구축하고, CI/CD 파이프라인에 통합하여 이미지 빌드를 자동화할 수 있습니다.

---

## 8. Reference

- [Packer Docs - Packer Documentation](https://developer.hashicorp.com/packer/docs)
- [Packer Docs - Build Command](https://developer.hashicorp.com/packer/docs/commands/build)
- [Packer Docs - Install Packer (macOS)](https://developer.hashicorp.com/packer/install#darwin)
- [Packer Docs - Amazon AMI Builder](https://developer.hashicorp.com/packer/integrations/hashicorp/amazon)
- [Packer Docs - HCL2 Templates](https://developer.hashicorp.com/packer/docs/templates/hcl_templates)

---

> **궁금하신 점이나 추가해야 할 부분은 댓글이나 아래의 링크를 통해 문의해주세요.**  
> **Written with [KKamJi](https://www.linkedin.com/in/taejikim/)**  
{: .prompt-info}
